<!DOCTYPE html>
<html>
<head>
    <title>Quiz</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* small visual tweaks to match your screenshot */
      .card { border-radius: 8px; }
      #timer { font-weight: 600; font-size: 1rem; }
    </style>
</head>

<body class="bg-light">

<div class="container d-flex justify-content-center mt-5">
    <div class="card shadow p-4 mb-5" style="width: 700px;">

        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h4 class="fw-bold mb-0">Question {{ number }} of {{ total }}</h4>
                <p class="text-muted mb-0">You can navigate back and forth. Answers are saved during the session.</p>
            </div>
            <div class="text-end">
                <div class="small text-muted">Time remaining</div>
                <div id="timer" class="text-danger">--:--</div>
            </div>
        </div>

        <hr class="my-3">

        <p class="mt-1 fs-5">{{ question_text }}</p>

        <form method="POST" id="quizForm">
            <textarea class="form-control" rows="6" name="answer" required>{{ current_answer }}</textarea>

            <div class="d-flex justify-content-between mt-4">

                {% if number > 1 %}
                <button name="action" value="previous" class="btn btn-outline-secondary">
                    Previous
                </button>
                {% else %}
                <span></span>
                {% endif %}

                <div>
                  {% if number < total %}
                  <button name="action" value="next" class="btn btn-primary">
                      Next
                  </button>
                  {% endif %}

                  {% if number == total %}
                  <button name="action" value="submit" id="submitBtn" class="btn btn-success">
                      Submit
                  </button>
                  {% endif %}
                </div>
            </div>
        </form>

        <hr class="mt-4">

        <p class="text-muted small mb-0">
            Your answers are saved for the session and submitted when you finish or when the timer ends.
        </p>

    </div>
</div>

<script>
    // remaining_seconds passed from Flask. Use 0 if not present.
    let timeLeft = Number("{{ remaining_seconds|default(0) }}");


    // If timeLeft is NaN or negative, default to 0
    if (!Number.isFinite(timeLeft) || timeLeft < 0) timeLeft = 0;

    const timerElement = document.getElementById("timer");
    const form = document.getElementById("quizForm");
    let autoSubmitting = false;

    function formatTime(t) {
        const m = Math.floor(t / 60);
        const s = t % 60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function updateTimerDisplay() {
        timerElement.innerText = formatTime(timeLeft);
    }

    function submitFormDueToTimeout() {
        if (autoSubmitting) return;
        autoSubmitting = true;

        // Ensure action=submit is sent
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "action";
        hidden.value = "submit";
        form.appendChild(hidden);

        // Optionally disable buttons to prevent double-clicks
        const buttons = form.querySelectorAll("button");
        buttons.forEach(b => b.disabled = true);

        // Submit
        form.submit();
    }

    // Show initial value immediately
    updateTimerDisplay();

    // If timeLeft is 0 at start, submit immediately
    if (timeLeft <= 0) {
        // small delay so browser completes rendering
        setTimeout(submitFormDueToTimeout, 200);
    } else {
        // countdown every second
        const timerInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(timerInterval);
                submitFormDueToTimeout();
                return;
            }
            updateTimerDisplay();
        }, 1000);
    }
</script>
<script>
document.addEventListener("visibilitychange", function () {
    if (document.hidden) {
        fetch("/tab_switched", {
            method: "POST"
        });
    }
});
</script>


</body>
</html>
