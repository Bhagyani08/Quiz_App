<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Question {{ idx }} / {{ total }}</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 24px; }

    /* GLOBAL LOGO */
    .logo {
        position: absolute;
        top: 15px;
        right: 20px;
        width: 140px;
        height: auto;
        z-index: 9999;
    }

    .timer { font-size: 22px; font-weight: bold; color: red; margin-bottom: 20px; }
    textarea { width: 100%; height: 140px; margin-top: 10px; }
    .nav-buttons { margin-top: 20px; }
    button { padding: 10px 20px; margin-right: 10px; cursor: pointer; }
    #submitBtn { background-color: green; color: white; }
  </style>
</head>

<body>

  <!-- SUPREMOLOGY LOGO (Right Corner) -->
  <img src="{{ url_for('static', filename='images/supremology_logo.png') }}" class="logo">

  <h2>Question {{ idx }} of {{ total }}</h2>

  <!-- GLOBAL QUIZ TIMER -->
  <div class="timer">Time left: <span id="time">{{ remaining_time }}</span></div>

  <p>{{ q.text }}</p>

  <!-- Answer Box -->
  <textarea id="answer" placeholder="Type your answer...">{{ attempt.answer if attempt else "" }}</textarea>

  <!-- Hidden form for Beacon API -->
  <form id="autosaveForm" style="display:none;">
      <input type="hidden" name="answer" id="autosaveAnswer">
      <input type="hidden" name="action" id="autosaveAction">
  </form>

  <!-- Navigation Buttons -->
  <div class="nav-buttons">
    <button id="prevBtn" {% if idx == 1 %}disabled{% endif %}>Previous</button>
    <button id="nextBtn" {% if idx == total %}disabled{% endif %}>Next</button>
    <button id="submitBtn" {% if idx != total %}disabled{% endif %}>Submit</button>
  </div>

  <script>
    // SAFE CONFIG BLOCK
    const CONFIG = JSON.parse(`{{ {
        "submit_url": url_for('submit_answer', token=token, qid=q.id),
        "idx": idx,
        "total": total,
        "remaining_time": remaining_time
    } | tojson | safe }}`);

    let timeLeft = CONFIG.remaining_time;
    const timerLabel = document.getElementById("time");
    const answerBox = document.getElementById("answer");

    // Convert seconds â†’ MM:SS format
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    // Initialize timer display
    timerLabel.textContent = formatTime(timeLeft);

    // GLOBAL TIMER
    const timer = setInterval(() => {
        timeLeft--;
        timerLabel.textContent = formatTime(timeLeft);

        if (timeLeft <= 0) {
            clearInterval(timer);
            saveAnswer("submit");  // Auto-submit on timeout
        }
    }, 1000);

    // Buttons
    document.getElementById("prevBtn").onclick = () => saveAnswer("prev");
    document.getElementById("nextBtn").onclick = () => saveAnswer("next");
    document.getElementById("submitBtn").onclick = () => saveAnswer("submit");

    // Save function
    function saveAnswer(action) {
        const fd = new FormData();
        fd.append("answer", answerBox.value);
        fd.append("action", action);

        fetch(CONFIG.submit_url, {
            method: "POST",
            body: fd
        })
        .then(r => r.json())
        .then(j => window.location.href = j.goto);
    }

    // Auto-save on tab close / refresh
    window.addEventListener("beforeunload", () => {
        const fd = new FormData();
        fd.append("answer", answerBox.value);
        fd.append("action", "autosave");
        navigator.sendBeacon(CONFIG.submit_url, fd);
    });
  </script>

</body>
</html>
